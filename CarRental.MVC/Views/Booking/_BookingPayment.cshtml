@using CarRental.MVC.Models.Booking
@model BookingViewModel

<div class="step-header">
    <h2><i class="fas fa-credit-card mr-2"></i>Payment Information</h2>
    <p class="mb-0">Choose your payment method and complete the booking</p>
</div>

<form id="payment-form" novalidate>
    @Html.AntiForgeryToken()
    
    <!-- Booking Summary Card -->
    <div class="form-card card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-receipt mr-2"></i>Booking Summary</h5>
        </div>
        <div class="card-body">
            <div class="booking-summary">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Rental Period:</strong> <span class="rental-period">@Model.NumberOfDays day(s)</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Number of Cars:</strong> @Model.CarItems.Count car(s)
                    </div>
                </div>
                
                @foreach (var car in Model.CarItems)
                {
                    <div class="car-summary border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@car.CarName</strong>
                                <small class="text-muted d-block">@car.LicensePlate</small>
                            </div>
                            <div class="text-right">
                                <div class="price-per-day">@car.PricePerDay.ToString("N0") VND × @Model.NumberOfDays days</div>
                                <small class="text-primary">Subtotal: <span class="car-subtotal">@car.SubTotal.ToString("N0")</span> VND</small>
                            </div>
                        </div>
                    </div>
                }
                
                <div class="row mt-3 pt-3 border-top">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between">
                            <span>Total Rental Fee:</span>
                            <strong class="text-primary total-amount">@Model.TotalAmount.ToString("N0") VND</strong>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between">
                            <span>Total Deposit:</span>
                            <strong class="text-warning total-deposit">@Model.TotalDeposit.ToString("N0") VND</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Methods Card -->
    <div class="form-card card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-credit-card mr-2"></i>Payment Method</h5>
        </div>
        <div class="card-body">
            <div class="payment-methods">
                
                <!-- Digital Wallet -->
                @if (Model.Payment.PaymentMethods.Wallet.IsAvailable)
                {
                    <div class="payment-option">
                        <div class="form-check payment-method-card">
                            <input class="form-check-input" type="radio" name="Payment.SelectedPaymentMethod" 
                                   id="wallet" value="1" required 
                                    @(Model.Payment.PaymentMethods.Wallet.HasSufficientFunds ? "" : "disabled")
                            >
                            <label class="form-check-label w-100" for="wallet">
                                <div class="payment-method-content">
                                    <div class="payment-method-header">
                                        <i class="fas fa-wallet text-primary mr-2"></i>
                                        <strong>Digital Wallet</strong>
                                        @if (!Model.Payment.PaymentMethods.Wallet.HasSufficientFunds)
                                        {
                                            <span class="badge badge-warning ml-2">Insufficient Balance</span>
                                        }
                                    </div>
                                    <div class="payment-method-details">
                                        <div class="d-flex justify-content-between">
                                            <span>Current Balance:</span>
                                            <span class="font-weight-bold current-balance">@Model.Payment.UserWallet.Balance.ToString("N0") VND</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Required Amount:</span>
                                            <span class="font-weight-bold text-warning required-amount">@Model.TotalDeposit.ToString("N0") VND</span>
                                        </div>
                                        @if (!Model.Payment.PaymentMethods.Wallet.HasSufficientFunds)
                                        {
                                            <small class="text-danger insufficient-warning">
                                                You need @((Model.TotalDeposit - Model.Payment.UserWallet.Balance).ToString("N0")) VND more in your wallet
                                            </small>
                                        }
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                }

                <!-- Cash Payment -->
                @if (Model.Payment.PaymentMethods.Cash.IsAvailable)
                {
                    <div class="payment-option">
                        <div class="form-check payment-method-card">
                            <input class="form-check-input" type="radio" name="Payment.SelectedPaymentMethod" 
                                   id="cash" value="2" required>
                            <label class="form-check-label w-100" for="cash">
                                <div class="payment-method-content">
                                    <div class="payment-method-header">
                                        <i class="fas fa-money-bill-wave text-success mr-2"></i>
                                        <strong>Cash Payment</strong>
                                        <span class="badge badge-info ml-2">Pay at Pickup</span>
                                    </div>
                                    <div class="payment-method-details">
                                        <p class="mb-1">Pay the deposit in cash when you pick up the car.</p>
                                        <div class="d-flex justify-content-between">
                                            <span>Deposit to Pay:</span>
                                            <span class="font-weight-bold text-success cash-amount">@Model.TotalDeposit.ToString("N0") VND</span>
                                        </div>
                                        <small class="text-muted">Please bring exact amount or be prepared for change</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                }

                <!-- Bank Transfer -->
                @if (Model.Payment.PaymentMethods.BankTransfer.IsAvailable)
                {
                    <div class="payment-option">
                        <div class="form-check payment-method-card">
                            <input class="form-check-input" type="radio" name="Payment.SelectedPaymentMethod" 
                                   id="banktransfer" value="3" required>
                            <label class="form-check-label w-100" for="banktransfer">
                                <div class="payment-method-content">
                                    <div class="payment-method-header">
                                        <i class="fas fa-university text-info mr-2"></i>
                                        <strong>Bank Transfer</strong>
                                        <span class="badge badge-warning ml-2">Manual Process</span>
                                    </div>
                                    <div class="payment-method-details">
                                        <p class="mb-1">Transfer the deposit to our bank account.</p>
                                        <div class="d-flex justify-content-between">
                                            <span>Amount to Transfer:</span>
                                            <span class="font-weight-bold text-info transfer-amount">@Model.TotalDeposit.ToString("N0") VND</span>
                                        </div>
                                        <small class="text-muted">Bank details will be provided after booking confirmation</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                }
            </div>
            
            <div class="invalid-feedback d-block" id="payment-method-error" style="display: none !important;">
                Please select a payment method
            </div>
        </div>
    </div>

    <!-- Terms and Conditions Card -->
    @* <div class="form-card card">
        <div class="card-body">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="agree-terms" required>
                <label class="form-check-label" for="agree-terms">
                    I agree to the <a href="#" data-toggle="modal" data-target="#termsModal">Terms and Conditions</a> 
                    and <a href="#" data-toggle="modal" data-target="#privacyModal">Privacy Policy</a>
                </label>
                <div class="invalid-feedback">
                    You must agree to the terms and conditions to proceed
                </div>
            </div>
        </div>
    </div> *@

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between mt-4">
        <button type="button" id="back-to-information" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Back to Information
        </button>
        <button type="button" id="complete-booking" class="btn btn-success btn-lg">
            Complete Booking <i class="fas fa-check ml-2"></i>
        </button>
    </div>
</form>

<!-- Terms Modal -->
@* <div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terms and Conditions</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6>1. Rental Agreement</h6>
                <p>By renting a car from us, you agree to return it in the same condition...</p>
                
                <h6>2. Driver Requirements</h6>
                <p>All drivers must be at least 18 years old with a valid driver's license...</p>
                
                <h6>3. Payment Terms</h6>
                <p>Deposit is required to secure the booking. Full payment is due upon return...</p>
                
                <h6>4. Cancellation Policy</h6>
                <p>Cancellations made 24 hours before pickup are eligible for full refund...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div> *@

<style>
.payment-method-card {
    border: 2px solid #e3e6f0;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-method-card:hover {
    border-color: #5a67d8;
    box-shadow: 0 2px 10px rgba(90, 103, 216, 0.1);
}

.payment-method-card.selected {
    border-color: #5a67d8;
    background-color: #f8f9ff;
    box-shadow: 0 2px 15px rgba(90, 103, 216, 0.2);
}

.payment-method-content {
    margin-left: 25px;
}

.payment-method-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.payment-method-details {
    font-size: 14px;
    color: #6c757d;
}

.car-summary {
    padding: 10px 0;
}

.form-check-input[type="radio"] {
    transform: scale(1.2);
}
</style>