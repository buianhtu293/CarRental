@using CarRental.MVC.Models.Booking
@model BookingViewModel

<div class="step-header">
    <h2><i class="fas fa-info-circle mr-2"></i>Booking Information</h2>
    <p class="mb-0">Please provide your rental details and personal information</p>
</div>

<form id="information-form" novalidate>
    @Html.AntiForgeryToken()
    
    <!-- Date Selection Card -->
    <div class="form-card card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-calendar mr-2"></i>Rental Period</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="PickupDate" class="form-label">Pickup Date</label>
                        <input type="datetime-local" id="PickupDate" name="Information.PickupDate" 
                               value="@Model.Information.PickupDate.ToString("yyyy-MM-ddTHH:00")"
                               class="form-control" required min="@DateTime.Today.ToString("yyyy-MM-ddTHH:00")">
                        <div class="invalid-feedback">Please select a pickup date</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="ReturnDate" class="form-label">Return Date</label>
                        <input type="datetime-local" id="ReturnDate" name="Information.ReturnDate" 
                               value="@Model.Information.ReturnDate.ToString("yyyy-MM-ddTHH:00")"
                               class="form-control" required min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-ddTHH:00")">
                        <div class="invalid-feedback">Please select a return date</div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info">
                <i class="fas fa-info-circle mr-2"></i>
                <strong>Rental Duration:</strong> <span id="rental-duration">@Model.NumberOfDays day(s)</span>
            </div>
        </div>
    </div>

    <!-- Car Information Card -->
    @if (Model.CarItems.Any())
    {
        <div class="form-card card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-car mr-2"></i>Selected Cars (@Model.CarItems.Count)</h5>
            </div>
            <div class="card-body">
                @foreach (var car in Model.CarItems)
                {
                    <div class="car-item border rounded p-3 mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <img src="@car.ImagePath" alt="@car.CarName" 
                                     class="img-fluid rounded" style="height: 80px; object-fit: cover;">
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-1">@car.CarName</h6>
                                <p class="text-muted mb-1">@car.LicensePlate</p>
                                <small class="text-muted">@car.Location</small>
                            </div>
                            <div class="col-md-3 text-right">
                                <div class="font-weight-bold text-primary" data-price="@car.PricePerDay">@car.PricePerDay.ToString("N0") VND/day</div>
                                <p class="text-muted mb-1">Deposit: @car.Deposit.ToString("N0") VND</p>
                                <p class="text-muted mb-1">SubTotal: <span class="car-subtotal">@car.SubTotal.ToString("N0")</span> VND</p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Renter Information Card -->
    <div class="form-card card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-user mr-2"></i>Renter Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="RenterFullName" class="form-label">Full Name</label>
                        <input type="text" id="RenterFullName" name="Information.Renter.FullName" 
                               value="@Model.Information.Renter.FullName" 
                               class="form-control" required placeholder="Enter your full name">
                        <div class="invalid-feedback">Please enter your full name</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="RenterEmail" class="form-label">Email Address</label>
                        <input type="email" id="RenterEmail" name="Information.Renter.Email" 
                               value="@Model.Information.Renter.Email" 
                               class="form-control" required placeholder="Enter your email">
                        <div class="invalid-feedback">Please enter a valid email address</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="RenterPhone" class="form-label">Phone Number</label>
                        <input type="tel" id="RenterPhone" name="Information.Renter.PhoneNumber" 
                               value="@Model.Information.Renter.PhoneNumber" 
                               class="form-control" required placeholder="Enter your phone number">
                        <div class="invalid-feedback">Please enter your phone number</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="RenterDateOfBirth" class="form-label">Date of Birth</label>
                        <input type="date" id="RenterDateOfBirth" name="Information.Renter.DateOfBirth" 
                               value="@Model.Information.Renter.DateOfBirth.ToString("yyyy-MM-dd")" 
                               class="form-control" required max="@DateTime.Today.AddYears(-18).ToString("yyyy-MM-dd")">
                        <div class="invalid-feedback">You must be at least 18 years old</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="RenterLicense" class="form-label">Driver License Number</label>
                        <input type="text" id="RenterLicense" name="Information.Renter.LicenseNumber" 
                               value="@Model.Information.Renter.LicenseNumber" 
                               class="form-control" required placeholder="Enter your license number">
                        <div class="invalid-feedback">Please enter your driver license number</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="RenterLicenseImage" class="form-label">Driver License Image</label>
                        <div class="license-upload-container">
                            <input type="file" id="RenterLicenseImage" name="Information.Renter.LicenseImageFile" 
                                   class="form-control renter-license-upload" accept="image/*">
                            <small class="form-text text-muted">Upload image of your driver license (Max 5MB)</small>
                            <div class="upload-progress" id="renter-upload-progress" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <small class="text-muted">Uploading...</small>
                            </div>
                            @if (!string.IsNullOrEmpty(Model.Information.Renter.LicenseImage))
                            {
                                <div class="license-preview mt-2" id="renter-license-preview">
                                    <img src="@Model.Information.Renter.LicenseImage" alt="License" class="img-thumbnail" style="max-width: 200px;">
                                    <button type="button" class="btn btn-sm btn-danger ml-2 remove-renter-license">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            }
                            <input type="hidden" name="Information.Renter.LicenseImage" value="@Model.Information.Renter.LicenseImage" id="renter-license-url">
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="RenterCity" class="form-label">City</label>
                    <select id="RenterCity" name="Information.Renter.City" class="form-control">
                        <option value="">-- Select City --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="RenterDistrict" class="form-label">District</label>
                    <select id="RenterDistrict" name="Information.Renter.District" class="form-control">
                        <option value="">-- Select District --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="RenterWard" class="form-label">Ward</label>
                    <select id="RenterWard" name="Information.Renter.Ward" class="form-control">
                        <option value="">-- Select Ward --</option>
                    </select>
                </div>
                <div class="col-12">
                    <div class="form-group">
                        <label for="RenterAddress" class="form-label">Address</label>
                        <input type="text" id="RenterAddress" name="Information.Renter.Address" 
                               value="@Model.Information.Renter.Address" 
                               class="form-control" placeholder="Enter your address">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Information Cards -->
    @if (Model.Information.Drivers.Any())
    {
        <div class="form-card card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-users mr-2"></i>Driver Information (@Model.Information.Drivers.Count drivers)</h5>
            </div>
            <div class="card-body">
                @for (int i = 0; i < Model.Information.Drivers.Count; i++)
                {
                    var driver = Model.Information.Drivers[i];
                    <div class="driver-card border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Driver for: @driver.CarName</h6>
                            <div class="form-check">
                                <input class="form-check-input same-as-renter" type="checkbox" 
                                       id="SameAsRenter_@i" data-driver-index="@i"
                                       name="Information.Drivers[@i].IsSameAsRenter"
                                       @(driver.IsSameAsRenter ? "checked" : "")>
                                <label class="form-check-label" for="SameAsRenter_@i">
                                    Same as renter
                                </label>
                            </div>
                        </div>
                        
                        <div class="driver-details @(driver.IsSameAsRenter ? "d-none" : "")" id="driver-details-@i">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Driver Full Name</label>
                                        <input type="text" name="Information.Drivers[@i].FullName" 
                                               value="@driver.FullName" class="form-control" 
                                               placeholder="Enter driver full name" required>
                                        <div class="invalid-feedback">Please enter driver full name</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Email Address</label>
                                        <input type="email" name="Information.Drivers[@i].Email" 
                                               value="@driver.Email" class="form-control" 
                                               placeholder="Enter driver email" required>
                                        <div class="invalid-feedback">Please enter a valid email address</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Phone Number</label>
                                        <input type="tel" name="Information.Drivers[@i].PhoneNumber" 
                                               value="@driver.PhoneNumber" class="form-control" 
                                               placeholder="Enter driver phone number" required>
                                        <div class="invalid-feedback">Please enter driver phone number</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Date of Birth</label>
                                        <input type="date" name="Information.Drivers[@i].DateOfBirth" 
                                               value="@driver.DateOfBirth.ToString("yyyy-MM-dd")" class="form-control" 
                                               max="@DateTime.Today.AddYears(-18).ToString("yyyy-MM-dd")" required>
                                        <div class="invalid-feedback">Driver must be at least 18 years old</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Driver License Number</label>
                                        <input type="text" name="Information.Drivers[@i].LicenseNumber" 
                                               value="@driver.LicenseNumber" class="form-control" 
                                               placeholder="Enter license number" required>
                                        <div class="invalid-feedback">Driver license number is required</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Driver License Image</label>
                                        <div class="license-upload-container">
                                            <input type="file" id="DriverLicenseImage_@i" name="Information.Drivers[@i].LicenseImageFile" 
                                                   class="form-control license-upload" accept="image/*" data-driver-index="@i">
                                            <small class="form-text text-muted">Upload image of driver license (Max 5MB)</small>
                                            <div class="upload-progress" id="upload-progress-@i" style="display: none;">
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                                </div>
                                                <small class="text-muted">Uploading...</small>
                                            </div>
                                            @if (!string.IsNullOrEmpty(driver.LicenseImage))
                                            {
                                                <div class="license-preview mt-2" id="license-preview-@i">
                                                    <img src="@driver.LicenseImage" alt="License" class="img-thumbnail" style="max-width: 200px;">
                                                    <button type="button" class="btn btn-sm btn-danger ml-2 remove-license" data-driver-index="@i">
                                                        <i class="fas fa-trash"></i> Remove
                                                    </button>
                                                </div>
                                            }
                                            <input type="hidden" name="Information.Drivers[@i].LicenseImage" value="@driver.LicenseImage" id="license-url-@i">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">City</label>
                                        <select id="DriverCity_@i" name="Information.Drivers[@i].City" class="form-control driver-city" 
                                                data-driver-index="@i" data-selected-city="@driver.City">
                                            <option value="">-- Select City --</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">District</label>
                                        <select id="DriverDistrict_@i" name="Information.Drivers[@i].District" class="form-control driver-district" 
                                                data-driver-index="@i" data-selected-district="@driver.District">
                                            <option value="">-- Select District --</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">Ward</label>
                                        <select id="DriverWard_@i" name="Information.Drivers[@i].Ward" class="form-control driver-ward" 
                                                data-driver-index="@i" data-selected-ward="@driver.Ward">
                                            <option value="">-- Select Ward --</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group">
                                        <label for="RenterAddress" class="form-label">Address</label>
                                        <input type="text" name="Information.Drivers[@i].Address" 
                                               value="@driver.Address" class="form-control" 
                                               placeholder="Enter driver address" required>
                                        <div class="invalid-feedback">Please enter driver address</div>
                                    </div>
                                </div>
							</div>
                        </div>
                        
                        <input type="hidden" name="Information.Drivers[@i].CarId" value="@driver.CarId">
                        <input type="hidden" name="Information.Drivers[@i].CarName" value="@driver.CarName">
                        <input type="hidden" name="Information.Drivers[@i].IsSameAsRenter" value="@driver.IsSameAsRenter.ToString().ToLower()">
                    </div>
                }
            </div>
        </div>
    }

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between mt-4">
        <a href="@Url.Action("Index", "Car")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left mr-2"></i>Back to Car Selection
        </a>
        <button type="button" id="continue-to-payment" class="btn btn-primary btn-lg">
            Continue to Payment <i class="fas fa-arrow-right ml-2"></i>
        </button>
    </div>
</form>